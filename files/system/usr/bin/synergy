#!/usr/bin/env bash

PREUSER=$USER

help() {
  echo "Usage: synergy <command> [options]"
  echo ""
  echo "Commands:"
  echo "  setup             Setup synergy"
  echo "  new [flags]       Create a new container"
  echo "  rm [flags]        Remove an existing container"
  echo "  switch            Switch containers"
  echo "  set-default       Set the default container started/opened on login"
  echo "  help              Display this message"
  echo "====> Danger Zone"
  echo "  host-exec <cmd>   Execute a command on the host system"
  echo "  host-shell        Open a shell on the host system, exit using 'exit'"
}

setup() {
  if [[ ! -d "/etc/containercfg.d/$USER" ]]; then
    echo "Hello there! Welcome to synergyOS!"
    echo "For you to access your shell, we need to set up the default container."
    echo "Don't worry! Hopefully, this wont take long. We'll tell you when we are done."
    apx subsystems new --name fedora-41 --stack fedora
    echo "Hey! We need your password."
    pkexec mkdir /etc/containercfg.d/$PREUSER
    pkexec echo "fedora-41" > /etc/containercfg.d/$PREUSER/default.conf
    echo "Done! Restart your shell to enjoy your container."
    clear
  else
    echo "Setup has already been completed!"
    echo "Use 'synergy help' for more commands."
    exit 1
  fi
}

new() {
  apx subsystems new $@
}

rm() {
  echo "Are you sure you want to do this?"
  read -p "y/n: " rm_confirm
  if [[ "$rm_confirm" == "y" ]]; then
    echo "Input the container to remove."
    apx subsystems list
    read -p "Container to remove: " container_name_rm
    apx subsystems rm $container_name_rm
  else
    echo "Cancelling."
    exit 1
  fi
}

switch() {
  echo "Input the container to switch to."
  echo "Format: apx-CONTAINER_NAME"
  echo "Containers:"
  apx subsystems list
  read -p "Container name: " container_name_switch
  echo "$container_name_switch" > ~/.config/containercfg.d/override.conf
  echo "Switch complete. Reopen this terminal to open your new container."
  echo "Note that it may take a second for the container to start."
}

default() {
  echo "Input the container to set as default."
  echo "Format: apx-CONTAINER_NAME"
  echo "Containers:"
  apx subsystems list
  read -p "Container name: " container_name_set-default
  echo "Setting default container to start... (requires authentication)"
  run0 echo "$container_name_set_default" > /etc/containercfg.d/$PREUSER/default.conf
  echo "Done."
}

host-exec() {
  distrobox-host-exec $@
}

host-shell() {
  clear
  echo "You are running a shell on the HOST SYSTEM! Proceed with caution."
  distrobox-host-exec bash
}

case "$1" in
  setup)
    setup
    ;;
  new)
    shift
    new "$@"
    ;;
  rm)
    shift
    rm "$@"
    ;;
  switch)
    switch
    ;;
  set-default)
    default
    ;;
  help)
    help
    ;;
  *)
    help
    exit 1
    ;;
esac

exit 0
